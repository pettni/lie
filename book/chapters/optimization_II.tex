% !TEX root = ../root.tex

\chapter{Optimization II: Pose-Graph Optimization}

\section{Maximum Likelihood Estimation}

\paragraph{Notation}:

\begin{enumerate}
  \item $X = \{ x_i \}$ set of variables
  \item $\hat y_j \in \mathbb{R}^{d_j}$
  \item $h_j$ measurement function s.t. $y_j \sim \mathcal N (h_j(X_j), \Sigma_j)$ for a (often small) subset of variables $X_j \subset X$.
\end{enumerate}


Given a collection of measurements $\hat y_j$ we are interested in finding the \textbf{maximum-likelihood estimate} of the variables $X$. In the Gaussian setting this becomes
$$
\begin{aligned}
  X^* = \underset{X}{\textrm{argmax}} \prod_{j} p_j(\hat y_j \mid X_j) = \underset{X}{\textrm{argmax}} \prod_j \frac{1}{\sqrt{ (2 \pi)^{d_j} |\Sigma_j|}} \exp \left( - \frac{(\hat y_j - h_j(X_j))^T \Sigma_j^{-1} (\hat y_j - h_j(X_j))}{2} \right) \\
= \underset{X}{\textrm{argmax}} \prod_j \exp \left( - \frac{(\hat y_j - h_j(X_j))^T \Sigma_j^{-1} (\hat y_j - h_j(X_j))}{2} \right)
\end{aligned}
$$
Maximizing $f(x)$ is equivalent to minimizing $2 \log(-f(x))$. Taking the negative log and multiplying by two yields
$$
  X^* = \underset{X}{\textrm{argmin}} \sum_j (\hat y_j - h_j(X_j))^T \Sigma_j^{-1} (\hat y_j - h_j(X_j)) = \underset{X}{\textrm{argmin}} \sum_j \left\| \sqrt{I}_j \left( \hat y_j - h_j(X_j) \right) \right\|^2,
$$
where $\sqrt{I}_j := \Sigma_j^{-1/2}$ is the \textbf{square root information matrix}. We have thus converted the maximum-likelihood estimation problem into a **least squares problem**. When the functions $h_j$  involve 3D geometry the least squares problem is typically **nonlinear**.

The least-squares problem can be viewed as a \textbf{bipartite factor graph} where variables and measurements (factors) are nodes. By exploiting the graph structure updates can be made locally in the graph, but this requires sophisticated data structures and solvers \cite{dellaert_factor_2017}.


\section{Measurement functions}

\subsection{Absolute pose measurement}

Let the measurement be $\hat y_j = \log(\hat P)$ where $\log : SE(3) \rightarrow \mathfrak{se}(3)$ is the logarithm on $SE(3)$ and $\hat P$ a pose measurement, then

$$
  h(P) = \log(P) \in \mathbb{R}^6.
$$
Since $SE(3) = SO(3) \times \mathbb{R}^3$ we can use the same formula for individual measurements of orientation ($SO(3)$) or position ($\mathbb{R}^3$).

\subsection{Relative pose measurement}

Let the measurement be $\hat y_j = \log(\hat P_{12})$ where $\log : SE(3) \rightarrow \mathfrak{se}(3)$ is the logarithm on $SE(3)$ and $\hat P_{12}$ an estimate of the relative pose. Then

$$
 h(P_1, P_2) = \log(P_1^{-1} P_2) \in \mathbb{R}^6.
$$

\subsection{Rectified stereo landmark measurement}

* $P \in SE(3)$ is the pose of the left camera (variable)
* $l \in \mathbb{R}^3$ world location of a landmark (variable)
* $P_{rl} \in SE(3)$ the pose of the right camera w.r.t. the left camera (known)
* $CM_l, CM_r$ camera projection matrices

The landmark is projected to the left and right image pixel planes as
$$
  \lambda_l \tilde \mathbf{x}_l = CM_l P^{-1} l, \quad \lambda_r \tilde \mathbf{x}_r = CM_r P_{rl} P^{-1} l.
$$
In a rectified system we have $y_l = y_r$, so we can let the 3-dimensional measurement be the pixel locations $\hat x_l, \hat x_r, \hat y_l$. The measurement function $h(P, l)$ is described by the equations above.
